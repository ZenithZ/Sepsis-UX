/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { IgControlBase } from '../igcontrolbase/igcontrolbase';
import { QueryList, ContentChild, ContentChildren, Input } from '@angular/core';
import { Column } from './column.directive';
import { Features } from './features.directive';
/**
 * @template Model
 */
export class IgGridBase extends IgControlBase {
    /**
     * @param {?} el
     * @param {?} renderer
     * @param {?} differs
     * @param {?} kvalDiffers
     * @param {?} cdr
     */
    constructor(el, renderer, differs, kvalDiffers, cdr) { super(el, renderer, differs, kvalDiffers, cdr); }
    /**
     * @param {?} value
     * @return {?}
     */
    set dataSource(value) {
        this._dataSource = value;
        /** @type {?} */
        const grid = jQuery(this._el).data(this._widgetName);
        if (grid) {
            jQuery(this._el)[this._widgetName]("option", "dataSource", this._dataSource);
        }
    }
    ;
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this._dataSource === null || this._dataSource === undefined) {
            this._dataSource = this.options["dataSource"];
        }
        if (!this.options["dataSource"] && this._dataSource) {
            this.options["dataSource"] = this._dataSource;
        }
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        if (this._columns && this._columns.length) {
            if (this.options) {
                this.options["columns"] = this._columns.map((/**
                 * @param {?} c
                 * @return {?}
                 */
                (c) => c._settings));
            }
        }
        if (this.featuresList) {
            if (this.options) {
                this.options["features"] = this.featuresList.allFeatures.map((/**
                 * @param {?} c
                 * @return {?}
                 */
                (c) => { return c.initSettings; }));
            }
        }
        if (this.options && this.options["features"] && !this.featuresList) {
            this.featuresList = new Features();
            //populate featuresList
            for (var i = 0; i < this.options["features"].length; i++) {
                /** @type {?} */
                var featureName = this.options["features"][i].name.charAt(0).toLowerCase() + this.options["features"][i].name.slice(1);
                this.featuresList.addFeature(featureName, this._el);
            }
        }
        super.ngOnInit();
    }
    /**
     * @param {?} value
     * @return {?}
     */
    createDataSource(value) {
        return jQuery.extend(true, [], value);
    }
    /**
     * @param {?} id
     * @param {?} index
     * @return {?}
     */
    deleteRow(id, index) {
        /** @type {?} */
        var element = jQuery(this._el);
        /** @type {?} */
        var tr = element.find("tr[data-id='" + id + "']");
        if (tr.length > 0) {
            tr.remove();
            jQuery(this._el).data(this._widgetName).dataSource.deleteRow(id, true);
            jQuery(this._el).data(this._widgetName).dataSource._removeTransactionsByRecordId(id);
        }
        this._changes.splice(index, 1);
    }
    /**
     * @param {?} rowData
     * @param {?} index
     * @return {?}
     */
    addRow(rowData, index) {
        /** @type {?} */
        var grid;
        /** @type {?} */
        var pkKey = this["primaryKey"] || this.options["primaryKey"];
        /** @type {?} */
        var existingDomRow = jQuery(this._el).find("tr[data-id='" + rowData[pkKey] + "']");
        /** @type {?} */
        var widgetName = this._widgetName;
        /** @type {?} */
        var existingRow;
        /** @type {?} */
        var t;
        if (this._widgetName === "igHierarchicalGrid") {
            widgetName = "igGrid";
        }
        grid = jQuery(this._el).data(widgetName);
        if (existingDomRow.length === 0) {
            grid.renderNewRow(rowData, rowData[pkKey]);
        }
        existingRow = grid.dataSource.findRecordByKey(rowData[pkKey]);
        if (!existingRow) {
            // add the row without affecting the original DS (scope source) 
            // TODO: trigger rowAdded event?
            grid.dataSource._addRow(rowData, index);
            //add transaction
            t = grid.dataSource._createNewRowTransaction(rowData[pkKey], rowData);
            grid.dataSource._addTransaction(t);
            grid.dataSource._removeTransactionByTransactionId(t.tid);
        }
        this._changes.push(this.kvalDiffers.find({}).create());
    }
    /**
     * @param {?} rec
     * @param {?} currValue
     * @param {?} key
     * @return {?}
     */
    updateRow(rec, currValue, key) {
        /** @type {?} */
        const pkKey = this["primaryKey"] || this.options["primaryKey"];
        /** @type {?} */
        let widgetName = this._widgetName;
        if (this._widgetName === "igHierarchicalGrid") {
            widgetName = "igGrid";
        }
        /** @type {?} */
        const element = jQuery(this._el);
        /** @type {?} */
        const grid = element.data(widgetName);
        /** @type {?} */
        const tr = element.find("tr[data-id='" + rec[pkKey] + "']");
        /** @type {?} */
        const column = grid.columnByKey(key);
        /** @type {?} */
        let newFormattedVal;
        /** @type {?} */
        let td;
        if (column) {
            if (column.template) {
                newFormattedVal = grid._renderTemplatedCell(rec, column);
            }
            else {
                newFormattedVal = grid._renderCell(currValue, column, rec);
            }
            td = grid._getCellsByColKey(element.find("tr[data-id='" + rec[pkKey] + "']"), key);
            //if current cell is still in edit mode, exit it.
            if (jQuery(td).find("input.ui-igedit-input").length > 0) {
                element.data("igGridUpdating").endEdit();
            }
            jQuery(td).html(newFormattedVal);
            if (grid.options.localSchemaTransform) {
                rec = grid.dataSource.schema().transform([rec])[0];
            }
            grid.dataSource.updateRow(rec[pkKey], rec);
            grid.dataSource._commitTransactionsByRowId(rec[pkKey]);
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        /** @type {?} */
        const ds = "dataSource";
        if (ds in changes) {
            /** @type {?} */
            const value = changes[ds].currentValue;
            if (value) {
                try {
                    this._differ = this._differs.find(value).create();
                    this._changes = [];
                    for (var i = 0; i < this._dataSource.length; i++) {
                        this._changes.push(this.kvalDiffers.find({}).create());
                    }
                }
                catch (e) {
                    throw new Error("Only binding to arrays is supported.");
                }
            }
        }
        super.ngOnChanges(changes);
    }
    /**
     * @return {?}
     */
    ngDoCheck() {
        if (this._differ) {
            /** @type {?} */
            const changes = this._differ.diff(this._dataSource);
            //check if grid is initialized
            /** @type {?} */
            const grid = jQuery(this._el).data(this._widgetName);
            if (changes && grid) {
                this.dataSourceApplyChanges(changes);
            }
            if (changes && changes.isDirty && grid) {
                //data source has been changed post initialization.
                jQuery(this._el)[this._widgetName]("option", "dataSource", this._dataSource);
            }
            if (this._changes && grid) {
                /** @type {?} */
                const pkKey = this["primaryKey"] || this.options["primaryKey"];
                //check recs
                for (var i = 0; i < this._dataSource.length; i++) {
                    /** @type {?} */
                    var item = this._dataSource[i];
                    /** @type {?} */
                    var rowChanges = this._changes[i].diff(item);
                    if (rowChanges) {
                        rowChanges.forEachChangedItem((/**
                         * @param {?} change
                         * @return {?}
                         */
                        (change) => {
                            this.updateRow(item, change.currentValue, change.key);
                        }));
                    }
                }
            }
        }
        super.ngDoCheck();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    dataSourceApplyChanges(changes) {
        /** @type {?} */
        const pkKey = this["primaryKey"] || this.options["primaryKey"];
        changes.forEachAddedItem((/**
         * @param {?} r
         * @return {?}
         */
        r => this.addRow(r.item, r.currentIndex)));
        changes.forEachRemovedItem((/**
         * @param {?} r
         * @return {?}
         */
        r => { this.deleteRow(r.item[pkKey], r.previousIndex); }));
    }
    /**
     * @return {?}
     */
    allRows() { }
    ;
}
IgGridBase.propDecorators = {
    dataSource: [{ type: Input }],
    _columns: [{ type: ContentChildren, args: [Column,] }],
    featuresList: [{ type: ContentChild, args: [Features, { static: true },] }]
};
if (false) {
    /**
     * @type {?}
     * @protected
     */
    IgGridBase.prototype._changes;
    /** @type {?} */
    IgGridBase.prototype._columns;
    /** @type {?} */
    IgGridBase.prototype.featuresList;
    /**
     * @type {?}
     * @private
     */
    IgGridBase.prototype._dataSource;
    /* Skipping unhandled member: ;*/
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWdncmlkYmFzZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2lnbml0ZXVpLWFuZ3VsYXItd3JhcHBlcnMvIiwic291cmNlcyI6WyJsaWIvaWdncmlkL2lnZ3JpZGJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUMvRCxPQUFPLEVBQW9CLFNBQVMsRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUF5RSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQzVMLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7Ozs7QUFFaEQsTUFBTSxPQUFPLFVBQWtCLFNBQVEsYUFBb0I7Ozs7Ozs7O0lBY3ZELFlBQVksRUFBYyxFQUFFLFFBQWtCLEVBQUUsT0FBd0IsRUFBRSxXQUE0QixFQUFFLEdBQXNCLElBQUksS0FBSyxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7O0lBYm5MLElBQ1csVUFBVSxDQUFDLEtBQVU7UUFDNUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7O2NBQ25CLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ3BELElBQUksSUFBSSxFQUFFO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDaEY7SUFDTCxDQUFDO0lBQUEsQ0FBQzs7OztJQVFGLFFBQVE7UUFDSixJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssSUFBSSxJQUFJLElBQUksQ0FB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QUFDLENBQUMsRUFBQyxDQUFDO0lBQ3pGLENBQUM7Ozs7SUFFRCxPQUFPLEtBQUssQ0FBQztJQUFBLENBQUM7Ozt5QkE5S2IsS0FBSzt1QkFTTCxlQUFlLFNBQUMsTUFBTTsyQkFDdEIsWUFBWSxTQUFDLFFBQVEsRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUM7Ozs7Ozs7SUFGdEMsOEJBQXdCOztJQUN4Qiw4QkFBcUQ7O0lBQ3JELGtDQUErRDs7Ozs7SUFDL0QsaUNBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSWdDb250cm9sQmFzZSB9IGZyb20gJy4uL2lnY29udHJvbGJhc2UvaWdjb250cm9sYmFzZSc7XG5pbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBRdWVyeUxpc3QsIENvbnRlbnRDaGlsZCwgQ29udGVudENoaWxkcmVuLCBFbGVtZW50UmVmLCBSZW5kZXJlciwgS2V5VmFsdWVEaWZmZXJzLCBJdGVyYWJsZURpZmZlcnMsIFNpbXBsZUNoYW5nZXMsIElucHV0LCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29sdW1uIH0gZnJvbSAnLi9jb2x1bW4uZGlyZWN0aXZlJztcbmltcG9ydCB7IEZlYXR1cmVzIH0gZnJvbSAnLi9mZWF0dXJlcy5kaXJlY3RpdmUnO1xuXG5leHBvcnQgY2xhc3MgSWdHcmlkQmFzZTxNb2RlbD4gZXh0ZW5kcyBJZ0NvbnRyb2xCYXNlPE1vZGVsPiBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQge1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIHNldCBkYXRhU291cmNlKHZhbHVlOiBhbnkpIHtcbiAgICAgICAgdGhpcy5fZGF0YVNvdXJjZSA9IHZhbHVlO1xuICAgICAgICBjb25zdCBncmlkID0galF1ZXJ5KHRoaXMuX2VsKS5kYXRhKHRoaXMuX3dpZGdldE5hbWUpO1xuICAgICAgICBpZiAoZ3JpZCkge1xuICAgICAgICAgICAgalF1ZXJ5KHRoaXMuX2VsKVt0aGlzLl93aWRnZXROYW1lXShcIm9wdGlvblwiLCBcImRhdGFTb3VyY2VcIiwgdGhpcy5fZGF0YVNvdXJjZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHByb3RlY3RlZCBfY2hhbmdlczogYW55O1xuICAgIEBDb250ZW50Q2hpbGRyZW4oQ29sdW1uKSBfY29sdW1uczogUXVlcnlMaXN0PENvbHVtbj47XG4gICAgQENvbnRlbnRDaGlsZChGZWF0dXJlcywge3N0YXRpYzogdHJ1ZX0pIGZlYXR1cmVzTGlzdDogRmVhdHVyZXM7XG4gICAgcHJpdmF0ZSBfZGF0YVNvdXJjZTtcblxuICAgIGNvbnN0cnVjdG9yKGVsOiBFbGVtZW50UmVmLCByZW5kZXJlcjogUmVuZGVyZXIsIGRpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycywga3ZhbERpZmZlcnM6IEtleVZhbHVlRGlmZmVycywgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZikgeyBzdXBlcihlbCwgcmVuZGVyZXIsIGRpZmZlcnMsIGt2YWxEaWZmZXJzLCBjZHIpOyB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2RhdGFTb3VyY2UgPT09IG51bGwgfHwgdGhpcy5fZGF0YVNvdXJjZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLl9kYXRhU291cmNlID0gdGhpcy5vcHRpb25zW1wiZGF0YVNvdXJjZVwiXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMub3B0aW9uc1tcImRhdGFTb3VyY2VcIl0gJiYgdGhpcy5fZGF0YVNvdXJjZSkge1xuICAgICAgICAgICAgdGhpcy5vcHRpb25zW1wiZGF0YVNvdXJjZVwiXSA9IHRoaXMuX2RhdGFTb3VyY2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgICAgICBpZiAodGhpcy5fY29sdW1ucyAmJiB0aGlzLl9jb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucykge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tcImNvbHVtbnNcIl0gPSB0aGlzLl9jb2x1bW5zLm1hcCgoYykgPT4gYy5fc2V0dGluZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmZlYXR1cmVzTGlzdCkge1xuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucykge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1tcImZlYXR1cmVzXCJdID0gdGhpcy5mZWF0dXJlc0xpc3QuYWxsRmVhdHVyZXMubWFwKChjKSA9PiB7IHJldHVybiBjLmluaXRTZXR0aW5nczsgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnNbXCJmZWF0dXJlc1wiXSAmJiAhdGhpcy5mZWF0dXJlc0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNMaXN0ID0gbmV3IEZlYXR1cmVzKCk7XG4gICAgICAgICAgICAvL3BvcHVsYXRlIGZlYXR1cmVzTGlzdFxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm9wdGlvbnNbXCJmZWF0dXJlc1wiXS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBmZWF0dXJlTmFtZSA9IHRoaXMub3B0aW9uc1tcImZlYXR1cmVzXCJdW2ldLm5hbWUuY2hhckF0KDApLnRvTG93ZXJDYXNlKCkgKyB0aGlzLm9wdGlvbnNbXCJmZWF0dXJlc1wiXVtpXS5uYW1lLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNMaXN0LmFkZEZlYXR1cmUoZmVhdHVyZU5hbWUsIHRoaXMuX2VsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xuICAgIH1cblxuICAgIGNyZWF0ZURhdGFTb3VyY2UodmFsdWU6IGFueSkge1xuICAgICAgICByZXR1cm4galF1ZXJ5LmV4dGVuZCh0cnVlLCBbXSwgdmFsdWUpO1xuICAgIH1cblxuICAgIGRlbGV0ZVJvdyhpZCwgaW5kZXgpIHtcbiAgICAgICAgdmFyIGVsZW1lbnQgPSBqUXVlcnkodGhpcy5fZWwpLFxuICAgICAgICAgICAgdHIgPSBlbGVtZW50LmZpbmQoXCJ0cltkYXRhLWlkPSdcIiArIGlkICsgXCInXVwiKTtcblxuICAgICAgICBpZiAodHIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdHIucmVtb3ZlKCk7XG4gICAgICAgICAgICBqUXVlcnkodGhpcy5fZWwpLmRhdGEodGhpcy5fd2lkZ2V0TmFtZSkuZGF0YVNvdXJjZS5kZWxldGVSb3coaWQsIHRydWUpO1xuICAgICAgICAgICAgalF1ZXJ5KHRoaXMuX2VsKS5kYXRhKHRoaXMuX3dpZGdldE5hbWUpLmRhdGFTb3VyY2UuX3JlbW92ZVRyYW5zYWN0aW9uc0J5UmVjb3JkSWQoaWQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NoYW5nZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG5cbiAgICBhZGRSb3cocm93RGF0YSwgaW5kZXgpIHtcbiAgICAgICAgdmFyIGdyaWQsIHBrS2V5ID0gdGhpc1tcInByaW1hcnlLZXlcIl0gfHwgdGhpcy5vcHRpb25zW1wicHJpbWFyeUtleVwiXSxcbiAgICAgICAgICAgIGV4aXN0aW5nRG9tUm93ID0galF1ZXJ5KHRoaXMuX2VsKS5maW5kKFwidHJbZGF0YS1pZD0nXCIgKyByb3dEYXRhW3BrS2V5XSArIFwiJ11cIiksXG4gICAgICAgICAgICB3aWRnZXROYW1lID0gdGhpcy5fd2lkZ2V0TmFtZSwgZXhpc3RpbmdSb3csIHQ7XG5cbiAgICAgICAgaWYgKHRoaXMuX3dpZGdldE5hbWUgPT09IFwiaWdIaWVyYXJjaGljYWxHcmlkXCIpIHtcbiAgICAgICAgICAgIHdpZGdldE5hbWUgPSBcImlnR3JpZFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgZ3JpZCA9IGpRdWVyeSh0aGlzLl9lbCkuZGF0YSh3aWRnZXROYW1lKTtcblxuICAgICAgICBpZiAoZXhpc3RpbmdEb21Sb3cubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBncmlkLnJlbmRlck5ld1Jvdyhyb3dEYXRhLCByb3dEYXRhW3BrS2V5XSk7XG4gICAgICAgIH1cblxuICAgICAgICBleGlzdGluZ1JvdyA9IGdyaWQuZGF0YVNvdXJjZS5maW5kUmVjb3JkQnlLZXkocm93RGF0YVtwa0tleV0pO1xuICAgICAgICBpZiAoIWV4aXN0aW5nUm93KSB7XG4gICAgICAgICAgICAvLyBhZGQgdGhlIHJvdyB3aXRob3V0IGFmZmVjdGluZyB0aGUgb3JpZ2luYWwgRFMgKHNjb3BlIHNvdXJjZSkgXG4gICAgICAgICAgICAvLyBUT0RPOiB0cmlnZ2VyIHJvd0FkZGVkIGV2ZW50P1xuICAgICAgICAgICAgZ3JpZC5kYXRhU291cmNlLl9hZGRSb3cocm93RGF0YSwgaW5kZXgpO1xuICAgICAgICAgICAgLy9hZGQgdHJhbnNhY3Rpb25cbiAgICAgICAgICAgIHQgPSBncmlkLmRhdGFTb3VyY2UuX2NyZWF0ZU5ld1Jvd1RyYW5zYWN0aW9uKHJvd0RhdGFbcGtLZXldLCByb3dEYXRhKTtcbiAgICAgICAgICAgIGdyaWQuZGF0YVNvdXJjZS5fYWRkVHJhbnNhY3Rpb24odCk7XG4gICAgICAgICAgICBncmlkLmRhdGFTb3VyY2UuX3JlbW92ZVRyYW5zYWN0aW9uQnlUcmFuc2FjdGlvbklkKHQudGlkKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2godGhpcy5rdmFsRGlmZmVycy5maW5kKHt9KS5jcmVhdGUoKSk7XG4gICAgfVxuICAgIHVwZGF0ZVJvdyhyZWMsIGN1cnJWYWx1ZSwga2V5KSB7XG4gICAgICAgIGNvbnN0IHBrS2V5ID0gdGhpc1tcInByaW1hcnlLZXlcIl0gfHwgdGhpcy5vcHRpb25zW1wicHJpbWFyeUtleVwiXTtcbiAgICAgICAgbGV0IHdpZGdldE5hbWUgPSB0aGlzLl93aWRnZXROYW1lO1xuICAgICAgICBpZiAodGhpcy5fd2lkZ2V0TmFtZSA9PT0gXCJpZ0hpZXJhcmNoaWNhbEdyaWRcIikge1xuICAgICAgICAgICAgd2lkZ2V0TmFtZSA9IFwiaWdHcmlkXCI7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGpRdWVyeSh0aGlzLl9lbCk7XG4gICAgICAgIGNvbnN0IGdyaWQgPSBlbGVtZW50LmRhdGEod2lkZ2V0TmFtZSk7XG4gICAgICAgIGNvbnN0IHRyID0gZWxlbWVudC5maW5kKFwidHJbZGF0YS1pZD0nXCIgKyByZWNbcGtLZXldICsgXCInXVwiKTtcbiAgICAgICAgY29uc3QgY29sdW1uID0gZ3JpZC5jb2x1bW5CeUtleShrZXkpO1xuICAgICAgICBsZXQgbmV3Rm9ybWF0dGVkVmFsO1xuICAgICAgICBsZXQgdGQ7XG4gICAgICAgIGlmIChjb2x1bW4pIHtcbiAgICAgICAgICAgIGlmIChjb2x1bW4udGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICBuZXdGb3JtYXR0ZWRWYWwgPSBncmlkLl9yZW5kZXJUZW1wbGF0ZWRDZWxsKHJlYywgY29sdW1uKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3Rm9ybWF0dGVkVmFsID0gZ3JpZC5fcmVuZGVyQ2VsbChjdXJyVmFsdWUsIGNvbHVtbiwgcmVjKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRkID0gZ3JpZC5fZ2V0Q2VsbHNCeUNvbEtleShlbGVtZW50LmZpbmQoXCJ0cltkYXRhLWlkPSdcIiArIHJlY1twa0tleV0gKyBcIiddXCIpLCBrZXkpO1xuICAgICAgICAgICAgLy9pZiBjdXJyZW50IGNlbGwgaXMgc3RpbGwgaW4gZWRpdCBtb2RlLCBleGl0IGl0LlxuICAgICAgICAgICAgaWYgKGpRdWVyeSh0ZCkuZmluZChcImlucHV0LnVpLWlnZWRpdC1pbnB1dFwiKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKFwiaWdHcmlkVXBkYXRpbmdcIikuZW5kRWRpdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgalF1ZXJ5KHRkKS5odG1sKG5ld0Zvcm1hdHRlZFZhbCk7XG4gICAgICAgICAgICBpZiAoZ3JpZC5vcHRpb25zLmxvY2FsU2NoZW1hVHJhbnNmb3JtKSB7XG4gICAgICAgICAgICAgICAgcmVjID0gZ3JpZC5kYXRhU291cmNlLnNjaGVtYSgpLnRyYW5zZm9ybShbcmVjXSlbMF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGdyaWQuZGF0YVNvdXJjZS51cGRhdGVSb3cocmVjW3BrS2V5XSwgcmVjKTtcbiAgICAgICAgICAgIGdyaWQuZGF0YVNvdXJjZS5fY29tbWl0VHJhbnNhY3Rpb25zQnlSb3dJZChyZWNbcGtLZXldKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGRzID0gXCJkYXRhU291cmNlXCI7XG4gICAgICAgIGlmIChkcyBpbiBjaGFuZ2VzKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGNoYW5nZXNbZHNdLmN1cnJlbnRWYWx1ZTtcbiAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2RpZmZlciA9IHRoaXMuX2RpZmZlcnMuZmluZCh2YWx1ZSkuY3JlYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9kYXRhU291cmNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2godGhpcy5rdmFsRGlmZmVycy5maW5kKHt9KS5jcmVhdGUoKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBiaW5kaW5nIHRvIGFycmF5cyBpcyBzdXBwb3J0ZWQuXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBzdXBlci5uZ09uQ2hhbmdlcyhjaGFuZ2VzKTtcbiAgICB9XG4gICAgbmdEb0NoZWNrKCkge1xuICAgICAgICBpZiAodGhpcy5fZGlmZmVyKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5fZGlmZmVyLmRpZmYodGhpcy5fZGF0YVNvdXJjZSk7XG4gICAgICAgICAgICAvL2NoZWNrIGlmIGdyaWQgaXMgaW5pdGlhbGl6ZWRcbiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSBqUXVlcnkodGhpcy5fZWwpLmRhdGEodGhpcy5fd2lkZ2V0TmFtZSk7XG4gICAgICAgICAgICBpZiAoY2hhbmdlcyAmJiBncmlkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlQXBwbHlDaGFuZ2VzKGNoYW5nZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNoYW5nZXMgJiYgY2hhbmdlcy5pc0RpcnR5ICYmIGdyaWQpIHtcbiAgICAgICAgICAgICAgICAvL2RhdGEgc291cmNlIGhhcyBiZWVuIGNoYW5nZWQgcG9zdCBpbml0aWFsaXphdGlvbi5cbiAgICAgICAgICAgICAgICBqUXVlcnkodGhpcy5fZWwpW3RoaXMuX3dpZGdldE5hbWVdKFwib3B0aW9uXCIsIFwiZGF0YVNvdXJjZVwiLCB0aGlzLl9kYXRhU291cmNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl9jaGFuZ2VzICYmIGdyaWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwa0tleSA9IHRoaXNbXCJwcmltYXJ5S2V5XCJdIHx8IHRoaXMub3B0aW9uc1tcInByaW1hcnlLZXlcIl07XG4gICAgICAgICAgICAgICAgLy9jaGVjayByZWNzXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9kYXRhU291cmNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5fZGF0YVNvdXJjZVtpXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJvd0NoYW5nZXMgPSB0aGlzLl9jaGFuZ2VzW2ldLmRpZmYoaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyb3dDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dDaGFuZ2VzLmZvckVhY2hDaGFuZ2VkSXRlbSgoY2hhbmdlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVJvdyhpdGVtLCBjaGFuZ2UuY3VycmVudFZhbHVlLCBjaGFuZ2Uua2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN1cGVyLm5nRG9DaGVjaygpO1xuICAgIH1cbiAgICBwdWJsaWMgZGF0YVNvdXJjZUFwcGx5Q2hhbmdlcyhjaGFuZ2VzKSB7XG4gICAgICAgIGNvbnN0IHBrS2V5ID0gdGhpc1tcInByaW1hcnlLZXlcIl0gfHwgdGhpcy5vcHRpb25zW1wicHJpbWFyeUtleVwiXTtcbiAgICAgICAgY2hhbmdlcy5mb3JFYWNoQWRkZWRJdGVtKHIgPT4gdGhpcy5hZGRSb3coci5pdGVtLCByLmN1cnJlbnRJbmRleCkpO1xuICAgICAgICBjaGFuZ2VzLmZvckVhY2hSZW1vdmVkSXRlbShyID0+IHsgdGhpcy5kZWxldGVSb3coci5pdGVtW3BrS2V5XSwgci5wcmV2aW91c0luZGV4KTsgfSk7XG4gICAgfVxuXG4gICAgYWxsUm93cygpIHsgfTtcbn1cbiJdfQ==