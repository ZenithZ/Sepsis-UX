/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { IgControlBase } from '../igcontrolbase/igcontrolbase';
import { QueryList, ContentChild, ContentChildren, Input } from '@angular/core';
import { Column } from './column.directive';
import { Features } from './features.directive';
/**
 * @template Model
 */
var IgGridBase = /** @class */ (function (_super) {
    tslib_1.__extends(IgGridBase, _super);
    function IgGridBase(el, renderer, differs, kvalDiffers, cdr) {
        return _super.call(this, el, renderer, differs, kvalDiffers, cdr) || this;
    }
    Object.defineProperty(IgGridBase.prototype, "dataSource", {
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._dataSource = value;
            /** @type {?} */
            var grid = jQuery(this._el).data(this._widgetName);
            if (grid) {
                jQuery(this._el)[this._widgetName]("option", "dataSource", this._dataSource);
            }
        },
        enumerable: true,
        configurable: true
    });
    ;
    /**
     * @return {?}
     */
    IgGridBase.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        if (this._dataSource === null || this._dataSource === undefined) {
            this._dataSource = this.options["dataSource"];
        }
        if (!this.options["dataSource"] && this._dataSource) {
            this.options["dataSource"] = this._dataSource;
        }
    };
    /**
     * @return {?}
     */
    IgGridBase.prototype.ngAfterContentInit = /**
     * @return {?}
     */
    function () {
        if (this._columns && this._columns.length) {
            if (this.options) {
                this.options["columns"] = this._columns.map((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c._settings; }));
            }
        }
        if (this.featuresList) {
            if (this.options) {
                this.options["features"] = this.featuresList.allFeatures.map((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.initSettings; }));
            }
        }
        if (this.options && this.options["features"] && !this.featuresList) {
            this.featuresList = new Features();
            //populate featuresList
            for (var i = 0; i < this.options["features"].length; i++) {
                /** @type {?} */
                var featureName = this.options["features"][i].name.charAt(0).toLowerCase() + this.options["features"][i].name.slice(1);
                this.featuresList.addFeature(featureName, this._el);
            }
        }
        _super.prototype.ngOnInit.call(this);
    };
    /**
     * @param {?} value
     * @return {?}
     */
    IgGridBase.prototype.createDataSource = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        return jQuery.extend(true, [], value);
    };
    /**
     * @param {?} id
     * @param {?} index
     * @return {?}
     */
    IgGridBase.prototype.deleteRow = /**
     * @param {?} id
     * @param {?} index
     * @return {?}
     */
    function (id, index) {
        /** @type {?} */
        var element = jQuery(this._el);
        /** @type {?} */
        var tr = element.find("tr[data-id='" + id + "']");
        if (tr.length > 0) {
            tr.remove();
            jQuery(this._el).data(this._widgetName).dataSource.deleteRow(id, true);
            jQuery(this._el).data(this._widgetName).dataSource._removeTransactionsByRecordId(id);
        }
        this._changes.splice(index, 1);
    };
    /**
     * @param {?} rowData
     * @param {?} index
     * @return {?}
     */
    IgGridBase.prototype.addRow = /**
     * @param {?} rowData
     * @param {?} index
     * @return {?}
     */
    function (rowData, index) {
        /** @type {?} */
        var grid;
        /** @type {?} */
        var pkKey = this["primaryKey"] || this.options["primaryKey"];
        /** @type {?} */
        var existingDomRow = jQuery(this._el).find("tr[data-id='" + rowData[pkKey] + "']");
        /** @type {?} */
        var widgetName = this._widgetName;
        /** @type {?} */
        var existingRow;
        /** @type {?} */
        var t;
        if (this._widgetName === "igHierarchicalGrid") {
            widgetName = "igGrid";
        }
        grid = jQuery(this._el).data(widgetName);
        if (existingDomRow.length === 0) {
            grid.renderNewRow(rowData, rowData[pkKey]);
        }
        existingRow = grid.dataSource.findRecordByKey(rowData[pkKey]);
        if (!existingRow) {
            // add the row without affecting the original DS (scope source) 
            // TODO: trigger rowAdded event?
            grid.dataSource._addRow(rowData, index);
            //add transaction
            t = grid.dataSource._createNewRowTransaction(rowData[pkKey], rowData);
            grid.dataSource._addTransaction(t);
            grid.dataSource._removeTransactionByTransactionId(t.tid);
        }
        this._changes.push(this.kvalDiffers.find({}).create());
    };
    /**
     * @param {?} rec
     * @param {?} currValue
     * @param {?} key
     * @return {?}
     */
    IgGridBase.prototype.updateRow = /**
     * @param {?} rec
     * @param {?} currValue
     * @param {?} key
     * @return {?}
     */
    function (rec, currValue, key) {
        /** @type {?} */
        var pkKey = this["primaryKey"] || this.options["primaryKey"];
        /** @type {?} */
        var widgetName = this._widgetName;
        if (this._widgetName === "igHierarchicalGrid") {
            widgetName = "igGrid";
        }
        /** @type {?} */
        var element = jQuery(this._el);
        /** @type {?} */
        var grid = element.data(widgetName);
        /** @type {?} */
        var tr = element.find("tr[data-id='" + rec[pkKey] + "']");
        /** @type {?} */
        var column = grid.columnByKey(key);
        /** @type {?} */
        var newFormattedVal;
        /** @type {?} */
        var td;
        if (column) {
            if (column.template) {
                newFormattedVal = grid._renderTemplatedCell(rec, column);
            }
            else {
                newFormattedVal = grid._renderCell(currValue, column, rec);
            }
            td = grid._getCellsByColKey(element.find("tr[data-id='" + rec[pkKey] + "']"), key);
            //if current cell is still in edit mode, exit it.
            if (jQuery(td).find("input.ui-igedit-input").length > 0) {
                element.data("igGridUpdating").endEdit();
            }
            jQuery(td).html(newFormattedVal);
            if (grid.options.localSchemaTransform) {
                rec = grid.dataSource.schema().transform([rec])[0];
            }
            grid.dataSource.updateRow(rec[pkKey], rec);
            grid.dataSource._commitTransactionsByRowId(rec[pkKey]);
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    IgGridBase.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var ds = "dataSource";
        if (ds in changes) {
            /** @type {?} */
            var value = changes[ds].currentValue;
            if (value) {
                try {
                    this._differ = this._differs.find(value).create();
                    this._changes = [];
                    for (var i = 0; i < this._dataSource.length; i++) {
                        this._changes.push(this.kvalDiffers.find({}).create());
                    }
                }
                catch (e) {
                    throw new Error("Only binding to arrays is supported.");
                }
            }
        }
        _super.prototype.ngOnChanges.call(this, changes);
    };
    /**
     * @return {?}
     */
    IgGridBase.prototype.ngDoCheck = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this._differ) {
            /** @type {?} */
            var changes = this._differ.diff(this._dataSource);
            //check if grid is initialized
            /** @type {?} */
            var grid = jQuery(this._el).data(this._widgetName);
            if (changes && grid) {
                this.dataSourceApplyChanges(changes);
            }
            if (changes && changes.isDirty && grid) {
                //data source has been changed post initialization.
                jQuery(this._el)[this._widgetName]("option", "dataSource", this._dataSource);
            }
            if (this._changes && grid) {
                /** @type {?} */
                var pkKey = this["primaryKey"] || this.options["primaryKey"];
                //check recs
                for (var i = 0; i < this._dataSource.length; i++) {
                    /** @type {?} */
                    var item = this._dataSource[i];
                    /** @type {?} */
                    var rowChanges = this._changes[i].diff(item);
                    if (rowChanges) {
                        rowChanges.forEachChangedItem((/**
                         * @param {?} change
                         * @return {?}
                         */
                        function (change) {
                            _this.updateRow(item, change.currentValue, change.key);
                        }));
                    }
                }
            }
        }
        _super.prototype.ngDoCheck.call(this);
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    IgGridBase.prototype.dataSourceApplyChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        /** @type {?} */
        var pkKey = this["primaryKey"] || this.options["primaryKey"];
        changes.forEachAddedItem((/**
         * @param {?} r
         * @return {?}
         */
        function (r) { return _this.addRow(r.item, r.currentIndex); }));
        changes.forEachRemovedItem((/**
         * @param {?} r
         * @return {?}
         */
        function (r) { _this.deleteRow(r.item[pkKey], r.previousIndex); }));
    };
    /**
     * @return {?}
     */
    IgGridBase.prototype.allRows = /**
     * @return {?}
     */
    function () { };
    ;
    IgGridBase.propDecorators = {
        dataSource: [{ type: Input }],
        _columns: [{ type: ContentChildren, args: [Column,] }],
        featuresList: [{ type: ContentChild, args: [Features, { static: true },] }]
    };
    return IgGridBase;
}(IgControlBase));
export { IgGridBase };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    IgGridBase.prototype._changes;
    /** @type {?} */
    IgGridBase.prototype._columns;
    /** @type {?} */
    IgGridBase.prototype.featuresList;
    /**
     * @type {?}
     * @private
     */
    IgGridBase.prototype._dataSource;
    /* Skipping unhandled member: ;*/
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWdncmlkYmFzZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2lnbml0ZXVpLWFuZ3VsYXItd3JhcHBlcnMvIiwic291cmNlcyI6WyJsaWIvaWdncmlkL2lnZ3JpZGJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDL0QsT0FBTyxFQUFvQixTQUFTLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBeUUsS0FBSyxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUM1TCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7O0FBRWhEO0lBQXVDLHNDQUFvQjtJQWN2RCxvQkFBWSxFQUFjLEVBQUUsUUFBa0IsRUFBRSxPQUF3QixFQUFFLFdBQTRCLEVBQUUsR0FBc0I7ZUFBSSxrQkFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsR0FBRyxDQUFDO0lBQUUsQ0FBQztJQWJuTCxzQkFDVyxrQ0FBVTs7Ozs7UUFEckIsVUFDc0IsS0FBVTtZQUM1QixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQzs7Z0JBQ25CLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO1lBQ3BELElBQUksSUFBSSxFQUFFO2dCQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ2hGO1FBQ0wsQ0FBQzs7O09BQUE7SUFBQSxDQUFDOzs7O0lBUUYsNkJBQVE7OztJQUFSO1FBQ0ksSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMs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QUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUM7SUFDekYsQ0FBQzs7OztJQUVELDRCQUFPOzs7SUFBUCxjQUFZLENBQUM7SUFBQSxDQUFDOzs2QkE5S2IsS0FBSzsyQkFTTCxlQUFlLFNBQUMsTUFBTTsrQkFDdEIsWUFBWSxTQUFDLFFBQVEsRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUM7O0lBcUsxQyxpQkFBQztDQUFBLEFBaExELENBQXVDLGFBQWEsR0FnTG5EO1NBaExZLFVBQVU7Ozs7OztJQVNuQiw4QkFBd0I7O0lBQ3hCLDhCQUFxRDs7SUFDckQsa0NBQStEOzs7OztJQUMvRCxpQ0FBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJZ0NvbnRyb2xCYXNlIH0gZnJvbSAnLi4vaWdjb250cm9sYmFzZS9pZ2NvbnRyb2xiYXNlJztcbmltcG9ydCB7IEFmdGVyQ29udGVudEluaXQsIFF1ZXJ5TGlzdCwgQ29udGVudENoaWxkLCBDb250ZW50Q2hpbGRyZW4sIEVsZW1lbnRSZWYsIFJlbmRlcmVyLCBLZXlWYWx1ZURpZmZlcnMsIEl0ZXJhYmxlRGlmZmVycywgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb2x1bW4gfSBmcm9tICcuL2NvbHVtbi5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRmVhdHVyZXMgfSBmcm9tICcuL2ZlYXR1cmVzLmRpcmVjdGl2ZSc7XG5cbmV4cG9ydCBjbGFzcyBJZ0dyaWRCYXNlPE1vZGVsPiBleHRlbmRzIElnQ29udHJvbEJhc2U8TW9kZWw+IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgc2V0IGRhdGFTb3VyY2UodmFsdWU6IGFueSkge1xuICAgICAgICB0aGlzLl9kYXRhU291cmNlID0gdmFsdWU7XG4gICAgICAgIGNvbnN0IGdyaWQgPSBqUXVlcnkodGhpcy5fZWwpLmRhdGEodGhpcy5fd2lkZ2V0TmFtZSk7XG4gICAgICAgIGlmIChncmlkKSB7XG4gICAgICAgICAgICBqUXVlcnkodGhpcy5fZWwpW3RoaXMuX3dpZGdldE5hbWVdKFwib3B0aW9uXCIsIFwiZGF0YVNvdXJjZVwiLCB0aGlzLl9kYXRhU291cmNlKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcHJvdGVjdGVkIF9jaGFuZ2VzOiBhbnk7XG4gICAgQENvbnRlbnRDaGlsZHJlbihDb2x1bW4pIF9jb2x1bW5zOiBRdWVyeUxpc3Q8Q29sdW1uPjtcbiAgICBAQ29udGVudENoaWxkKEZlYXR1cmVzLCB7c3RhdGljOiB0cnVlfSkgZmVhdHVyZXNMaXN0OiBGZWF0dXJlcztcbiAgICBwcml2YXRlIF9kYXRhU291cmNlO1xuXG4gICAgY29uc3RydWN0b3IoZWw6IEVsZW1lbnRSZWYsIHJlbmRlcmVyOiBSZW5kZXJlciwgZGlmZmVyczogSXRlcmFibGVEaWZmZXJzLCBrdmFsRGlmZmVyczogS2V5VmFsdWVEaWZmZXJzLCBjZHI6IENoYW5nZURldGVjdG9yUmVmKSB7IHN1cGVyKGVsLCByZW5kZXJlciwgZGlmZmVycywga3ZhbERpZmZlcnMsIGNkcik7IH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBpZiAodGhpcy5fZGF0YVNvdXJjZSA9PT0gbnVsbCB8fCB0aGlzLl9kYXRhU291cmNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2RhdGFTb3VyY2UgPSB0aGlzLm9wdGlvbnNbXCJkYXRhU291cmNlXCJdO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zW1wiZGF0YVNvdXJjZVwiXSAmJiB0aGlzLl9kYXRhU291cmNlKSB7XG4gICAgICAgICAgICB0aGlzLm9wdGlvbnNbXCJkYXRhU291cmNlXCJdID0gdGhpcy5fZGF0YVNvdXJjZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLl9jb2x1bW5zICYmIHRoaXMuX2NvbHVtbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW1wiY29sdW1uc1wiXSA9IHRoaXMuX2NvbHVtbnMubWFwKChjKSA9PiBjLl9zZXR0aW5ncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZmVhdHVyZXNMaXN0KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zW1wiZmVhdHVyZXNcIl0gPSB0aGlzLmZlYXR1cmVzTGlzdC5hbGxGZWF0dXJlcy5tYXAoKGMpID0+IHsgcmV0dXJuIGMuaW5pdFNldHRpbmdzOyB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5vcHRpb25zICYmIHRoaXMub3B0aW9uc1tcImZlYXR1cmVzXCJdICYmICF0aGlzLmZlYXR1cmVzTGlzdCkge1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc0xpc3QgPSBuZXcgRmVhdHVyZXMoKTtcbiAgICAgICAgICAgIC8vcG9wdWxhdGUgZmVhdHVyZXNMaXN0XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMub3B0aW9uc1tcImZlYXR1cmVzXCJdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGZlYXR1cmVOYW1lID0gdGhpcy5vcHRpb25zW1wiZmVhdHVyZXNcIl1baV0ubmFtZS5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIHRoaXMub3B0aW9uc1tcImZlYXR1cmVzXCJdW2ldLm5hbWUuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgdGhpcy5mZWF0dXJlc0xpc3QuYWRkRmVhdHVyZShmZWF0dXJlTmFtZSwgdGhpcy5fZWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN1cGVyLm5nT25Jbml0KCk7XG4gICAgfVxuXG4gICAgY3JlYXRlRGF0YVNvdXJjZSh2YWx1ZTogYW55KSB7XG4gICAgICAgIHJldHVybiBqUXVlcnkuZXh0ZW5kKHRydWUsIFtdLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgZGVsZXRlUm93KGlkLCBpbmRleCkge1xuICAgICAgICB2YXIgZWxlbWVudCA9IGpRdWVyeSh0aGlzLl9lbCksXG4gICAgICAgICAgICB0ciA9IGVsZW1lbnQuZmluZChcInRyW2RhdGEtaWQ9J1wiICsgaWQgKyBcIiddXCIpO1xuXG4gICAgICAgIGlmICh0ci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0ci5yZW1vdmUoKTtcbiAgICAgICAgICAgIGpRdWVyeSh0aGlzLl9lbCkuZGF0YSh0aGlzLl93aWRnZXROYW1lKS5kYXRhU291cmNlLmRlbGV0ZVJvdyhpZCwgdHJ1ZSk7XG4gICAgICAgICAgICBqUXVlcnkodGhpcy5fZWwpLmRhdGEodGhpcy5fd2lkZ2V0TmFtZSkuZGF0YVNvdXJjZS5fcmVtb3ZlVHJhbnNhY3Rpb25zQnlSZWNvcmRJZChpZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY2hhbmdlcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cblxuICAgIGFkZFJvdyhyb3dEYXRhLCBpbmRleCkge1xuICAgICAgICB2YXIgZ3JpZCwgcGtLZXkgPSB0aGlzW1wicHJpbWFyeUtleVwiXSB8fCB0aGlzLm9wdGlvbnNbXCJwcmltYXJ5S2V5XCJdLFxuICAgICAgICAgICAgZXhpc3RpbmdEb21Sb3cgPSBqUXVlcnkodGhpcy5fZWwpLmZpbmQoXCJ0cltkYXRhLWlkPSdcIiArIHJvd0RhdGFbcGtLZXldICsgXCInXVwiKSxcbiAgICAgICAgICAgIHdpZGdldE5hbWUgPSB0aGlzLl93aWRnZXROYW1lLCBleGlzdGluZ1JvdywgdDtcblxuICAgICAgICBpZiAodGhpcy5fd2lkZ2V0TmFtZSA9PT0gXCJpZ0hpZXJhcmNoaWNhbEdyaWRcIikge1xuICAgICAgICAgICAgd2lkZ2V0TmFtZSA9IFwiaWdHcmlkXCI7XG4gICAgICAgIH1cblxuICAgICAgICBncmlkID0galF1ZXJ5KHRoaXMuX2VsKS5kYXRhKHdpZGdldE5hbWUpO1xuXG4gICAgICAgIGlmIChleGlzdGluZ0RvbVJvdy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGdyaWQucmVuZGVyTmV3Um93KHJvd0RhdGEsIHJvd0RhdGFbcGtLZXldKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGV4aXN0aW5nUm93ID0gZ3JpZC5kYXRhU291cmNlLmZpbmRSZWNvcmRCeUtleShyb3dEYXRhW3BrS2V5XSk7XG4gICAgICAgIGlmICghZXhpc3RpbmdSb3cpIHtcbiAgICAgICAgICAgIC8vIGFkZCB0aGUgcm93IHdpdGhvdXQgYWZmZWN0aW5nIHRoZSBvcmlnaW5hbCBEUyAoc2NvcGUgc291cmNlKSBcbiAgICAgICAgICAgIC8vIFRPRE86IHRyaWdnZXIgcm93QWRkZWQgZXZlbnQ/XG4gICAgICAgICAgICBncmlkLmRhdGFTb3VyY2UuX2FkZFJvdyhyb3dEYXRhLCBpbmRleCk7XG4gICAgICAgICAgICAvL2FkZCB0cmFuc2FjdGlvblxuICAgICAgICAgICAgdCA9IGdyaWQuZGF0YVNvdXJjZS5fY3JlYXRlTmV3Um93VHJhbnNhY3Rpb24ocm93RGF0YVtwa0tleV0sIHJvd0RhdGEpO1xuICAgICAgICAgICAgZ3JpZC5kYXRhU291cmNlLl9hZGRUcmFuc2FjdGlvbih0KTtcbiAgICAgICAgICAgIGdyaWQuZGF0YVNvdXJjZS5fcmVtb3ZlVHJhbnNhY3Rpb25CeVRyYW5zYWN0aW9uSWQodC50aWQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaCh0aGlzLmt2YWxEaWZmZXJzLmZpbmQoe30pLmNyZWF0ZSgpKTtcbiAgICB9XG4gICAgdXBkYXRlUm93KHJlYywgY3VyclZhbHVlLCBrZXkpIHtcbiAgICAgICAgY29uc3QgcGtLZXkgPSB0aGlzW1wicHJpbWFyeUtleVwiXSB8fCB0aGlzLm9wdGlvbnNbXCJwcmltYXJ5S2V5XCJdO1xuICAgICAgICBsZXQgd2lkZ2V0TmFtZSA9IHRoaXMuX3dpZGdldE5hbWU7XG4gICAgICAgIGlmICh0aGlzLl93aWRnZXROYW1lID09PSBcImlnSGllcmFyY2hpY2FsR3JpZFwiKSB7XG4gICAgICAgICAgICB3aWRnZXROYW1lID0gXCJpZ0dyaWRcIjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBlbGVtZW50ID0galF1ZXJ5KHRoaXMuX2VsKTtcbiAgICAgICAgY29uc3QgZ3JpZCA9IGVsZW1lbnQuZGF0YSh3aWRnZXROYW1lKTtcbiAgICAgICAgY29uc3QgdHIgPSBlbGVtZW50LmZpbmQoXCJ0cltkYXRhLWlkPSdcIiArIHJlY1twa0tleV0gKyBcIiddXCIpO1xuICAgICAgICBjb25zdCBjb2x1bW4gPSBncmlkLmNvbHVtbkJ5S2V5KGtleSk7XG4gICAgICAgIGxldCBuZXdGb3JtYXR0ZWRWYWw7XG4gICAgICAgIGxldCB0ZDtcbiAgICAgICAgaWYgKGNvbHVtbikge1xuICAgICAgICAgICAgaWYgKGNvbHVtbi50ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIG5ld0Zvcm1hdHRlZFZhbCA9IGdyaWQuX3JlbmRlclRlbXBsYXRlZENlbGwocmVjLCBjb2x1bW4pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXdGb3JtYXR0ZWRWYWwgPSBncmlkLl9yZW5kZXJDZWxsKGN1cnJWYWx1ZSwgY29sdW1uLCByZWMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGQgPSBncmlkLl9nZXRDZWxsc0J5Q29sS2V5KGVsZW1lbnQuZmluZChcInRyW2RhdGEtaWQ9J1wiICsgcmVjW3BrS2V5XSArIFwiJ11cIiksIGtleSk7XG4gICAgICAgICAgICAvL2lmIGN1cnJlbnQgY2VsbCBpcyBzdGlsbCBpbiBlZGl0IG1vZGUsIGV4aXQgaXQuXG4gICAgICAgICAgICBpZiAoalF1ZXJ5KHRkKS5maW5kKFwiaW5wdXQudWktaWdlZGl0LWlucHV0XCIpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoXCJpZ0dyaWRVcGRhdGluZ1wiKS5lbmRFZGl0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBqUXVlcnkodGQpLmh0bWwobmV3Rm9ybWF0dGVkVmFsKTtcbiAgICAgICAgICAgIGlmIChncmlkLm9wdGlvbnMubG9jYWxTY2hlbWFUcmFuc2Zvcm0pIHtcbiAgICAgICAgICAgICAgICByZWMgPSBncmlkLmRhdGFTb3VyY2Uuc2NoZW1hKCkudHJhbnNmb3JtKFtyZWNdKVswXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZ3JpZC5kYXRhU291cmNlLnVwZGF0ZVJvdyhyZWNbcGtLZXldLCByZWMpO1xuICAgICAgICAgICAgZ3JpZC5kYXRhU291cmNlLl9jb21taXRUcmFuc2FjdGlvbnNCeVJvd0lkKHJlY1twa0tleV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZHMgPSBcImRhdGFTb3VyY2VcIjtcbiAgICAgICAgaWYgKGRzIGluIGNoYW5nZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gY2hhbmdlc1tkc10uY3VycmVudFZhbHVlO1xuICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlmZmVyID0gdGhpcy5fZGlmZmVycy5maW5kKHZhbHVlKS5jcmVhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2RhdGFTb3VyY2UubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaCh0aGlzLmt2YWxEaWZmZXJzLmZpbmQoe30pLmNyZWF0ZSgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IGJpbmRpbmcgdG8gYXJyYXlzIGlzIHN1cHBvcnRlZC5cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN1cGVyLm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xuICAgIH1cbiAgICBuZ0RvQ2hlY2soKSB7XG4gICAgICAgIGlmICh0aGlzLl9kaWZmZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IGNoYW5nZXMgPSB0aGlzLl9kaWZmZXIuZGlmZih0aGlzLl9kYXRhU291cmNlKTtcbiAgICAgICAgICAgIC8vY2hlY2sgaWYgZ3JpZCBpcyBpbml0aWFsaXplZFxuICAgICAgICAgICAgY29uc3QgZ3JpZCA9IGpRdWVyeSh0aGlzLl9lbCkuZGF0YSh0aGlzLl93aWRnZXROYW1lKTtcbiAgICAgICAgICAgIGlmIChjaGFuZ2VzICYmIGdyaWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VBcHBseUNoYW5nZXMoY2hhbmdlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2hhbmdlcyAmJiBjaGFuZ2VzLmlzRGlydHkgJiYgZ3JpZCkge1xuICAgICAgICAgICAgICAgIC8vZGF0YSBzb3VyY2UgaGFzIGJlZW4gY2hhbmdlZCBwb3N0IGluaXRpYWxpemF0aW9uLlxuICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzLl9lbClbdGhpcy5fd2lkZ2V0TmFtZV0oXCJvcHRpb25cIiwgXCJkYXRhU291cmNlXCIsIHRoaXMuX2RhdGFTb3VyY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuX2NoYW5nZXMgJiYgZ3JpZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBrS2V5ID0gdGhpc1tcInByaW1hcnlLZXlcIl0gfHwgdGhpcy5vcHRpb25zW1wicHJpbWFyeUtleVwiXTtcbiAgICAgICAgICAgICAgICAvL2NoZWNrIHJlY3NcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2RhdGFTb3VyY2UubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLl9kYXRhU291cmNlW2ldO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcm93Q2hhbmdlcyA9IHRoaXMuX2NoYW5nZXNbaV0uZGlmZihpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd0NoYW5nZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd0NoYW5nZXMuZm9yRWFjaENoYW5nZWRJdGVtKChjaGFuZ2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUm93KGl0ZW0sIGNoYW5nZS5jdXJyZW50VmFsdWUsIGNoYW5nZS5rZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIubmdEb0NoZWNrKCk7XG4gICAgfVxuICAgIHB1YmxpYyBkYXRhU291cmNlQXBwbHlDaGFuZ2VzKGNoYW5nZXMpIHtcbiAgICAgICAgY29uc3QgcGtLZXkgPSB0aGlzW1wicHJpbWFyeUtleVwiXSB8fCB0aGlzLm9wdGlvbnNbXCJwcmltYXJ5S2V5XCJdO1xuICAgICAgICBjaGFuZ2VzLmZvckVhY2hBZGRlZEl0ZW0ociA9PiB0aGlzLmFkZFJvdyhyLml0ZW0sIHIuY3VycmVudEluZGV4KSk7XG4gICAgICAgIGNoYW5nZXMuZm9yRWFjaFJlbW92ZWRJdGVtKHIgPT4geyB0aGlzLmRlbGV0ZVJvdyhyLml0ZW1bcGtLZXldLCByLnByZXZpb3VzSW5kZXgpOyB9KTtcbiAgICB9XG5cbiAgICBhbGxSb3dzKCkgeyB9O1xufVxuIl19